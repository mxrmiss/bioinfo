------

# 总览：模块与因果链

```
(来自 phylo/)                  ┌────────────┐
ML 物种树(supermatrix.treefile) ─► A. 时间标定 ├─► A2. 超度量树(ultra.pretty.nwk)
Orthogroups 结果(RESULTS_PATH) ─► B. CAFE 家族 ├─► B2. 分支扩/缩(branch_changes.tsv)
AA 超矩阵(supermatrix.aa.fas) ─► C. 密码子对齐 ┐
CDS/GFF（如需）                 ┘              ├─► D. 正选择(codeml) ─► FDR/位点表
校准文件(化石/TimeTree) ───────────────────────► A. 时间标定         ┘
                                                    │
A2 + B2 ─► E. FigA 数据（panelA_branch_changes.tsv）
Orthogroups.GeneCount.tsv ─► F. FigB 数据（panelB_species_bars.tsv）
FDR 结果 + B2 ─► G. 交叉总结 & FigC（panelC_selection_summary.tsv）
```

> 关键点：**不再调用 IQ-TREE 二进制**；只**读取**你在 `phylo/` 已经产出的物种树（ML 拓扑）与 OrthoFinder 家族计数，随后在 `phylo-post/` 完成“时间化→CAFE→正选择→面板数据”。

------

# 模块 A｜时间标定（MCMCTREE；输出超度量树）

**目标**：把 `phylo` 的 ML 物种树（相对枝长）→ **带时间单位（Ma）的超度量树**，供 CAFE 与作图叠加。

## A1. 近似似然准备（approximate likelihood）

- **输入**：固定拓扑（来自 ML 物种树），核酸矩阵（建议用 **4DTV** 串联矩阵，或同源 CDS 对齐）。
- **软件**：PAML 套件（`baseml`/`codeml` 用于近似似然；`mcmctree` 主程序）。
- **关键思想**：`usedata = 3`（approximate likelihood）模式下，先用 baseml/codeml 估计梯度与 Hessian，以加速后续 MCMC。
- **建议设置**（概念 & 参数）
  - **序列类型/模型**：核酸模型（HKY 或 GTR）；AΓ4 类位点速率（`ncatG=4`）。
    - `kappa` 自由估计（`fix_kappa=0`），`alpha` 可固定或估计（常见 `alpha≈0.5–1.0`）。
  - **数据**：优先 **4DTV 位点**（减少选择偏倚）；如未准备 4DTV，也可用三联子对齐但要一致过滤。
  - **拓扑**：**固定**为 ML 物种树（不再重搜）。

## A2. MCMC 时间标定（mcmctree）

- **输入**：A1 的近似似然结果 + **校准约束** + 固定拓扑。
- **校准**：基于化石/TimeTree 的**软界限**（Soft bounds），在树的内部节点上给 **B(L,U)**、**L(min)**、**U(max)** 等约束。
- **钟模型（clock）**：
  - `clock = 2` **独立速率（IGR）**（常用、鲁棒）；
  - 或 `clock = 3` **自相关速率（AR）**（若你有明确理由）。
- **先验（常见可解释设定）**：
  - `rgene_gamma = (α, β)`：整体替换率先验（均值 α/β）。习惯把均值设为 ~1 的量级，或与数据尺度一致。
  - `sigma2_gamma = (α, β)`：分支速率变异先验（IGR/AR 的关键超参），α 常取 1–5，β 调整以给“温和变动”。
  - `bdparas = (λ, μ, ρ)`：出生–死亡先验（常用 `1 1 0`）。
  - `priors.rootage`：根年龄上限/分布（与校准一致以避免冲突）。
- **MCMC**：
  - `burnin = 2e4`、`nsample = 2e4`、`samplefreq = 10`（示例量级；可视 ESS 调整）；
  - 跑 ≥2 条链做**收敛检查**（PSRF、trace 视觉检视）。
- **输出**：**超度量树**（节点带时间），记为 **A2**。
- **后处理**：统一 tip 命名（与后续家族/作图一致）、时间小数位规整（便于标注）。

> 因果：**A2（超度量树）** 是 **B 模块（CAFE）** 的硬性输入，并被 **E 模块（FigA）** 直接消费。

------

# 模块 B｜基因家族扩张/收缩（CAFE v5）

**目标**：用 OrthoFinder 的家族计数 + 超度量树，推断各分支的家族 **扩张(+)/收缩(−)**。

## B1. 输入准备

- **输入**：`Orthogroups.GeneCount.tsv`（从 `RESULTS_PATH.txt` 指向的 `Results_*/Orthogroups/` 解析而来）。
- **列名统一**：用 `species_rename.tsv` 将列名与 **A2 的 tip 名**严格一致（避免 CAFE 映射错误）。
- **过滤**：可按总计数（如 `≤ 5000`）去掉超大/异常家族；可保证所有物种均有列。

## B2. CAFE 运行（v5）

- **输入**：B1 的计数表 + **A2 超度量树（单位 Ma）**。
- **模型**：
  - **全局 λ**（单一增减率；**默认推荐**）；
  - 或多 λ（不同谱系 λ 不同，需事先定义分组；数据量足时再用）。
- **检验**：家族层面显著性 **p ≤ 0.05**（可多重纠正）；可选择报告每个分支的最可能状态变化。
- **并行**：适度线程；CAFE 不是纯 CPU 密集，I/O 也要考虑。
- **输出**：
  - 家族显著性报告（整体/逐家族）；
  - **分支级汇总**：统计每条分支上的 **扩张数 / 收缩数**，记为 **B2**（`branch_changes.tsv`）。

> 因果：**B2** 与 **A2** 一起喂给 **E（FigA）**；此外 **B2** 将与 **D/FDR** 在 **G 模块**交叉。

------

# 模块 C｜密码子对齐（为正选择做准备）

**目标**：为候选同源簇（OG）构建 **密码子级对齐**，保证 codeml/HyPhy 的模型假设成立。

## C1. 候选目标集

- **来源**：
  - **SCO**（Single-Copy Orthologues；最稳，**默认**）；
  - 或与 CAFE 显著家族**取交/并**（看你的研究重点）；
  - 或提供自定义 `OG 列表`。
- **下限**：每个 OG 至少 `min_taxa` 物种（例如 ≥6），避免 LRT 不稳定。

## C2. 氨基酸→密码子映射

- **推荐**：`PAL2NAL`，用已对齐的 **AA MSA** + **对应 CDS** 生成 codon 对齐。
  - **常用选项**（概念）：
    - **遗传密码表**：标准表；
    - **缺口/错配策略**：`-nogap`/`-nomismatch`（避免非法三联子）；
    - **输出格式**：PAML 友好（保持三联子完整）。
- **可替代**：`MACSE`（容忍移码/早停，更“保守”）。

## C3. 质控（对齐清洗）

- **阈值建议**：
  - **物种数** `≥ min_taxa`（如 6）；
  - **编码长度** `≥ min_codon_len`（如 150 个密码子）；
  - **缺口比例** `≤ max_gap_frac`（如 0.5）；
  - **内部终止子**：**直接剔除序列或该基因**（`drop_gene` 更稳）；必要时记录原因。
- **结果**：规范的 `codon.aln`（每 OG 一份），供 D 模块直接使用。

> 因果：C 模块产物是 **D（正选择）** 的硬输入；若同时做 4DTV，**A 模块**也在 C 后可获得核酸矩阵来源。

------

# 模块 D｜正选择检测（PAML codeml 分支–位点；HyPhy 可选）

**目标**：在**指定前景分支**上检测 **适应性正选择**；输出基因层面的显著结果与位点（BEB）。

## D1. 前景分支定义

- **树源**：默认用 **A2 超度量树** 的拓扑（每 OG 可按取样进行剪枝）。
- **标注**：把目标物种/谱系标成**前景分支**。分支–位点测试语义：**仅该分支**上的某些位点允许 ω>1。

## D2. codeml（branch-site，Test 2）

- **比较对**：
  - **Alt**：分支–位点 Model A（允许前景位点类 ω2≥1）；
  - **Null**：同模型但 **固定** `ω2 = 1`（`fix_omega = 1, omega = 1`）。
- **典型参数（易与审稿标准对齐）**：
  - `seqtype = 1`（codon）；`runmode = 0`；
  - **模型**：`model = 2`（branch-site）；`NSsites = 2`（正选择）；
  - **频率**：`CodonFreq = 2`（F3×4；也常见 F1×4）；
  - **kappa**：`fix_kappa = 0`（估计），`kappa` 初值 ~2；
  - **位点速率**：分支–位点框架下常用 `fix_alpha = 1, alpha = 0`（不叠加 Γ位点）；
  - **类别数**：`ncatG = 4`；
  - **数据清理**：`cleandata = 1`（移除含不明字符的列）；
  - **起始值**：`omega` 初值可设 1.5（Alt）或 1（Null），多次起始复算可更稳。
- **LRT**：`2Δℓ = 2(ℓ_alt − ℓ_null)`；**Test 2** 的 p 值服从 **0.5·χ²₁** 的混合分布（或取 χ²₁更保守）。
- **BEB**：在显著基因中，取 **BEB posterior ≥ 0.95** 的位点作为强证据（报告位点编号与氨基酸）。

## D3. 多重校正与汇总

- **每前景/每基因**的 p 值做 **BH-FDR**（`q ≤ 0.05` 常用）；
- 输出层级：基因显著表、BEB 位点表、汇总统计（每前景显著基因数等）。

## D4. HyPhy（可选互证；默认不开）

- **BUSTED**：问“该基因在**任意分支**是否存在 episodic 正选择”（基因层）。
- **aBSREL**：问“**该分支**是否存在 episodic 正选择”（分支层）。
- **MEME**：问“**该位点**在某些分支是否 episodic 正选择”（位点层）。
- **阈值**：一般 α=0.05；MEME 有人用 0.1 做探索。
- **用途**：与 codeml 形成“基因/分支/位点”的**三维交叉证据**（可在后续 FigC 展示）。

> 因果：D 的显著结果将与 B2 在 **G 模块**交叉，形成“**扩张 ∧ 正选择**”的适应性证据带。

------

# 模块 E｜FigA 数据（时间树 × 分支扩缩）

- **输入**：**A2**（超度量树） + **B2**（分支扩/缩计数）。
- **输出**：`panelA_branch_changes.tsv`（每分支 +/−），外加树文件供作图。
- **可视化建议**：
  - 背景以 ICS 地质年代分段（Triassic→Neogene）上色（可独立提供 `epochs.tsv`）；
  - 节点时间标注与 CAFE 叠加数字颜色（红/蓝）。

------

# 模块 F｜FigB 数据（物种家族组成）

- **输入**：`Orthogroups.GeneCount.tsv`（经物种名统一）。
- **统计口径**（每物种四类）：
  - **Single-copy**：该物种在某家族计数 = 1；
  - **Species-specific**：该家族仅此物种 > 0；
  - **Multiple-copy**：该物种在某家族计数 > 1；
  - **Other**：不落入以上三类的剩余。
- **输出**：`panelB_species_bars.tsv`（堆叠柱状图即用；物种顺序可按树序或自定义）。

------

# 模块 G｜交叉与 FigC（正选择 × 扩张）

- **输入**：D 的 FDR 显著基因表 + **B2** 分支扩/缩表。
- **目标**：在“目标前景”上统计 “**发生正选择** 的基因中，有多少出自 **扩张家族**”，形成交叉证据。
- **输出**：`panelC_selection_summary.tsv`（可再派生韦恩/Upset、热图等）。

------

# 关键“握手契约”与一致性

1. **树名一致**：超度量树的 tip 名必须与 `GeneCount.tsv` 列名一致（`species_rename.tsv` 统一映射）。
2. **校准透明**：把化石/TimeTree 约束写成明确的节点软界限，并随项目版本化（注明来源与日期）。
3. **对齐质量**：密码子对齐必须通过最小 QC（物种数、长度、缺口、早停策略）；否则 LRT 易偏。
4. **统计可追溯**：输出 run manifest（输入文件路径+hash、工具版本、核心参数），保证半年后可完全复现。

------

# 参数清单（便于你审稿前逐条对齐）

**MCMCTREE（时间标定）**

- 近似似然：核酸模型 **HKY/GTR + Γ4**；`usedata=3`；固定拓扑（ML 物种树）。
- 钟模型：`clock=2`（IGR，推荐）/ `clock=3`（AR）。
- 先验：`rgene_gamma=(α,β)`；`sigma2_gamma=(α,β)`；`bdparas=1,1,0`；根年龄与节点软界限一致。
- MCMC：`burnin≈20k`、`nsample≈20k`、`samplefreq=10`（按 ESS 调整；至少双链）。
- 输出：超度量树（Ma）；tip 名重命名，小数位规整（例如 6 位）。

**CAFE v5**

- 输入：统一物种名的计数表 + **超度量树（Ma）**；可设最大家族大小过滤（如 ≤5000）。
- 模型：**全局 λ**（默认）；必要时多 λ（需谱系分组）。
- 显著性：家族层面 `p ≤ 0.05`；分支级扩/缩计数汇总。
- 输出：分支扩张/收缩表（`branch_changes.tsv`）。

**codeml（分支–位点，Test 2）**

- 模式：`model=2, NSsites=2`；**Alt**：`fix_omega=0`（ω 自由）；**Null**：`fix_omega=1, omega=1`。
- 其他：`seqtype=1`、`runmode=0`、`CodonFreq=2(F3×4)`、`fix_kappa=0,kappa≈2`、`fix_alpha=1,alpha=0`、`ncatG=4`、`cleandata=1`。
- LRT：`2Δℓ` 按 **0.5·χ²₁** 混合分布（或 χ²₁ 保守）；BEB：`Pr ≥ 0.95` 标注位点。
- 多重检验：BH-FDR，`q ≤ 0.05` 记为显著。

**HyPhy（可选互证）**

- BUSTED（基因层 episodic）、aBSREL（分支层 episodic）、MEME（位点层 episodic）；
- α 通常 0.05（MEME 有时 0.1 做探索）；与 codeml 形成交叉证据。

**密码子对齐（PAL2NAL / MACSE）**

- 基本：AA MSA + CDS → codon MSA；
- PAL2NAL 常用策略：**标准遗传码**；`-nogap/-nomismatch` 以避免非法三联子；输出 PAML 友好。
- 质控阈值：`min_taxa≥6`、`min_codon_len≥150`、`max_gap_frac≤0.5`、内部终止子剔除。

------

# 为什么这套“去 IQ-TREE”是收敛且自洽的？

- 上游 `phylo/` 已经给了**可信的 ML 拓扑**；时间化只需 **MCMCTREE** + 校准信息，无需重跑 IQ-TREE。
- **codeml** 会在**固定拓扑**下**重估分支长度**并完成似然比较，因此也不强依赖 IQ-TREE 的分支长。
- **CAFE** 要求的是**超度量树**（单位时间），我们直接用 **A2** 即可。
- 因此，全链路只需“读树不重算”，计算集中在 MCMCTREE、CAFE 与 codeml，符合效率与审稿口味。

